## [Question 29 (Jan 10, 2024)](https://stackoverflow.com/questions/77793841/how-do-i-configure-core-protections-and-rate-limiting-in-cloudformation-temp)

How do I configure "Core protections" and "Rate limiting" in CloudFormation template for a CloudFront distribution

So I am trying to configure AWS::CloudFront::Distribution so that the basic security protections are enabled.

[At the moment in the AWS Dashboard the Security tab of the distribution looks like this after deployment.](https://i.sstatic.net/Yf6n2.png)

[And I am trying to configure these options](https://i.sstatic.net/ieAH0.png), but I can't find anything from the documentation that describes how to do it in CloudFormation template.


The following is my base configuration for the CloudFront distribution:

```yml
CloudFrontDistribution:
  Type: AWS::CloudFront::Distribution
  Properties:
    DistributionConfig:
      Origins:
        - Id: S3Origin
          DomainName:
            Fn::Join:
              - ''
              - - !Ref FrontendS3Bucket
                - '.s3-${env:REGION}.amazonaws.com'
          S3OriginConfig:
            OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${FrontendS3OAI}'
        - Id: ApiGatewayOrigin
          DomainName:
            Fn::Join:
              - ''
              - - !Ref HttpApi
                - '.execute-api.${env:REGION}.amazonaws.com'
          CustomOriginConfig:
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
              - TLSv1.2
      DefaultRootObject: index.html
      DefaultCacheBehavior:
        TargetOriginId: S3Origin
        CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # Managed-CachingOptimized
        ViewerProtocolPolicy: https-only
      CacheBehaviors:
        - TargetOriginId: ApiGatewayOrigin
          PathPattern: /api/*
          ViewerProtocolPolicy: https-only
          OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac # Managed-AllViewerExceptHostHeader
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # Managed-CachingDisabled
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - PATCH
            - POST
            - DELETE
      Enabled: true
```


## Baseline answer 

Rate limit is part of Web Application Firewall, you can see in your screenshot also.
This is way to configure this.

**Step 1**
Create a WAF using this.
https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-wafv2-webacl-ratebasedstatement.html

[![enter image description here][1]][1]
**Step 2**
Integrate WAF with Cloudfront distribution
https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distribution-distributionconfig.html



[![enter image description here][2]][2]


  [1]: https://i.sstatic.net/MHcJb.png
  [2]: https://i.sstatic.net/1TTkn.png

## ChatGPT 4o

### **Configuring "Core protections" and "Rate limiting" in AWS CloudFormation for CloudFront**

AWS **CloudFront "Core protections" and "Rate limiting"** are part of AWS **WAF (Web Application Firewall)**, which integrates with CloudFront distributions. To enable these security features in your **CloudFormation template**, you need to:

1. **Create an AWS WAF WebACL with security protections**.
2. **Associate the WebACL with your CloudFront distribution**.

---

## **Step 1: Add AWS WAF WebACL to CloudFormation**
### **Define WAF WebACL with Core Protections & Rate Limiting**
Add the following **AWS WAF WebACL** to your CloudFormation template:

```yaml
WebACL:
  Type: AWS::WAFv2::WebACL
  Properties:
    Name: CloudFrontSecurityACL
    Scope: CLOUDFRONT
    DefaultAction:
      Allow: {}  # Allow by default unless blocked by rules
    Rules:
      - Name: AWSManagedRulesCommonRuleSet
        Priority: 1
        OverrideAction:
          None: {}
        Statement:
          ManagedRuleGroupStatement:
            VendorName: AWS
            Name: AWSManagedRulesCommonRuleSet
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: CommonRuleSet

      - Name: AWSManagedRulesAmazonIpReputationList
        Priority: 2
        OverrideAction:
          None: {}
        Statement:
          ManagedRuleGroupStatement:
            VendorName: AWS
            Name: AWSManagedRulesAmazonIpReputationList
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: IpReputation

      - Name: RateLimitRule
        Priority: 3
        Action:
          Block: {}  # Block requests exceeding rate limit
        Statement:
          RateBasedStatement:
            Limit: 1000  # Limit requests to 1000 per 5 minutes
            AggregateKeyType: IP
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: RateLimitRule

    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: CloudFrontSecurityACLMetric
```

âœ… **What this does:**
- **AWSManagedRulesCommonRuleSet** â†’ Protects against common threats.
- **AWSManagedRulesAmazonIpReputationList** â†’ Blocks known malicious IPs.
- **RateLimitRule** â†’ Blocks IPs exceeding 1000 requests per 5 minutes.

---

## **Step 2: Associate WAF WebACL with CloudFront**
Modify your **CloudFrontDistribution** configuration to link it to the WAF ACL:

```yaml
CloudFrontDistribution:
  Type: AWS::CloudFront::Distribution
  Properties:
    DistributionConfig:
      WebACLId: !GetAtt WebACL.Arn  # Attach WAF WebACL to CloudFront
      Origins:
        - Id: S3Origin
          DomainName:
            Fn::Join:
              - ''
              - - !Ref FrontendS3Bucket
                - '.s3-${env:REGION}.amazonaws.com'
          S3OriginConfig:
            OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${FrontendS3OAI}'
        - Id: ApiGatewayOrigin
          DomainName:
            Fn::Join:
              - ''
              - - !Ref HttpApi
                - '.execute-api.${env:REGION}.amazonaws.com'
          CustomOriginConfig:
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
              - TLSv1.2
      DefaultRootObject: index.html
      DefaultCacheBehavior:
        TargetOriginId: S3Origin
        CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # Managed-CachingOptimized
        ViewerProtocolPolicy: https-only
      CacheBehaviors:
        - TargetOriginId: ApiGatewayOrigin
          PathPattern: /api/*
          ViewerProtocolPolicy: https-only
          OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac # Managed-AllViewerExceptHostHeader
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # Managed-CachingDisabled
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - PATCH
            - POST
            - DELETE
      Enabled: true
```

âœ… **What this does:**
- Adds `WebACLId: !GetAtt WebACL.Arn`, which **attaches the WAF WebACL to CloudFront**.

---

## **Step 3: Deploy CloudFormation**
Run the deployment:
```sh
aws cloudformation deploy --stack-name MyCloudFrontStack --template-file my-template.yml --capabilities CAPABILITY_NAMED_IAM
```

---

## **Final Checklist**
| **Feature** | **Implemented Solution** |
|------------|--------------------------|
| âœ… **Enable "Core Protections"** | Added `AWSManagedRulesCommonRuleSet` & `AWSManagedRulesAmazonIpReputationList` |
| âœ… **Enable "Rate Limiting"** | Added `RateBasedStatement` (1000 requests per 5 min) |
| âœ… **Attach WAF to CloudFront** | Used `WebACLId: !GetAtt WebACL.Arn` |
| âœ… **Deploy with CloudFormation** | `aws cloudformation deploy ...` |

---

## **Conclusion**
By following these steps, you now have **CloudFront security protections enabled** via **CloudFormation**. This setup protects against **common threats, malicious IPs, and excessive requests**.

ðŸš€ **After deployment, you should see "Core Protections" and "Rate Limiting" enabled in AWS Console.** ðŸš€

Let me know if you need further assistance! âœ…

## Gemini

The user wants to configure "Core protections" (AWS WAF Web ACL) and "Rate limiting" (AWS WAF Rate-based rules) for their CloudFront distribution using CloudFormation, but can't find the relevant documentation.

Here's how to configure these features in your CloudFormation template:

**Understanding the Problem:**

* **CloudFront Security Features:**
    * "Core protections" and "Rate limiting" are implemented using AWS WAF (Web Application Firewall).
    * To enable these features, you need to associate a WAF Web ACL with your CloudFront distribution.
* **CloudFormation Documentation:**
    * The `AWS::CloudFront::Distribution` resource does not directly include properties for configuring WAF rules.
    * Instead, you need to create a `AWS::WAFv2::WebACL` resource and then associate it with your CloudFront distribution using the `WebACLId` property of the `DistributionConfig`.

**Solutions:**

1.  **Create a `AWS::WAFv2::WebACL` Resource:**

    * Define a `AWS::WAFv2::WebACL` resource in your CloudFormation template.
    * Configure the rules for "Core protections" and "Rate limiting" within the Web ACL.
    * Example of a basic rate limiting rule:

    ```yaml
    WebACL:
      Type: AWS::WAFv2::WebACL
      Properties:
        Name: MyWebACL
        Scope: CLOUDFRONT
        DefaultAction:
          Allow: {}
        Rules:
          - Name: RateLimitRule
            Priority: 0
            Action:
              Block: {}
            Statement:
              RateBasedStatement:
                Limit: 100 # Adjust the rate limit as needed
                AggregateKeyType: IP
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: RateLimitRuleMetric
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: WebACLMetric
    ```
    * To add core protections, you will need to add managed rule groups. AWS managed rule groups can be added inside of the rules section of the WebACL. Here is an example of adding the AWS managed core ruleset.

    ```yaml
          - Name: AWS-AWSManagedRulesCoreRuleSet
            Priority: 1
            Statement:
              ManagedRuleGroupStatement:
                VendorName: AWS
                Name: AWSManagedRulesCoreRuleSet
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: AWSManagedRulesCoreRuleSetMetric
    ```

2.  **Associate the Web ACL with the CloudFront Distribution:**

    * In your `AWS::CloudFront::Distribution` resource, add the `WebACLId` property to the `DistributionConfig`.
    * Set the `WebACLId` to the ARN of the `AWS::WAFv2::WebACL` resource.

    ```yaml
    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          # ... other properties ...
          WebACLId: !GetAtt WebACL.Arn
    ```

**Complete Example:**

```yaml
Resources:
  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: MyWebACL
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      Rules:
        - Name: RateLimitRule
          Priority: 0
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 100
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitRuleMetric
        - Name: AWS-AWSManagedRulesCoreRuleSet
          Priority: 1
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCoreRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSManagedRulesCoreRuleSetMetric
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: WebACLMetric
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: S3Origin
            DomainName:
              Fn::Join:
                - ''
                - - !Ref FrontendS3Bucket
                  - '.s3-${env:REGION}.amazonaws.com'
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${FrontendS3OAI}'
          - Id: ApiGatewayOrigin
            DomainName:
              Fn::Join:
                - ''
                - - !Ref HttpApi
                  - '.execute-api.${env:REGION}.amazonaws.com'
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          ViewerProtocolPolicy: https-only
        CacheBehaviors:
          - TargetOriginId: ApiGatewayOrigin
            PathPattern: /api/*
            ViewerProtocolPolicy: https-only
            OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - PATCH
              - POST
              - DELETE
        Enabled: true
        WebACLId: !GetAtt WebACL.Arn
```

**Key Points:**

* **AWS WAFv2:** Use `AWS::WAFv2::WebACL` for CloudFront distributions. WAFv1 is not compatible.
* **Scope:** Set the `Scope` property of the `WebACL` to `CLOUDFRONT`.
* **Rules:** Configure your desired WAF rules within the `Rules` property of the `WebACL`.
* **Association:** Use the `WebACLId` property of the `DistributionConfig` to associate the Web ACL with your CloudFront distribution.
* **Managed Rule Groups:** Use managed rule groups to add core protections.
* **Rate Based Rules:** Use rate based rules to add rate limiting.
* **Testing:** After deployment, thoroughly test your CloudFront distribution to ensure that the WAF rules are working as expected.


## Q

Maximum character count is 1000 characters.

## DeepSeek R1

To configure **Core Protections** and **Rate Limiting** for your CloudFront distribution in CloudFormation, you need to associate a WebACL (AWS WAF) with your distribution. Here's how to do it:

### Step 1: Add WAF WebACL Configuration
```yaml
Resources:
  # Add WAF WebACL with core protections and rate limiting
  CloudFrontWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: CloudFrontSecurityWebACL
      Scope: CLOUDFRONT  # Required for CloudFront distributions
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: CloudFrontSecurityWebACL
      Rules:
        # Core Protections (AWS Managed Rules)
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 0
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSManagedRulesCommonRuleSet
        
        # Rate Limiting Rule
        - Name: RateLimitRule
          Priority: 1
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 1000  # Requests per 5-minute period
              AggregateKeyType: IP  # Or use FORWARDED_IP if using X-Forwarded-For
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitRule
```

### Step 2: Associate WebACL with CloudFront Distribution
```yaml
CloudFrontDistribution:
  Type: AWS::CloudFront::Distribution
  Properties:
    DistributionConfig:
      WebACLId: !GetAtt CloudFrontWebACL.Arn  # Add this line
      # Rest of your existing configuration
      Origins:
        - Id: S3Origin
          # ... existing origin config ...
      DefaultCacheBehavior:
        # ... existing cache behavior ...
```

### Key Notes:
1. **Scope Requirement**: WAF for CloudFront must use `CLOUDFRONT` scope and be deployed in the **us-east-1** region
2. **Managed Rules**: `AWSManagedRulesCommonRuleSet` provides SQLi, XSS, etc. protections
3. **Rate Limiting**: Adjust the `Limit` value based on your needs (requests per 5-minute period)
4. **Blocking Threshold**: Add additional rules with higher priority numbers for stricter controls

### Full Implementation Example:
```yaml
Resources:
  CloudFrontWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: CloudFrontSecurityWebACL
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: CloudFrontSecurityWebACL
      Rules:
        - Name: AWSManagedRulesCommonRuleSet
          Priority: 0
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSManagedRulesCommonRuleSet
        
        - Name: RateLimitRule
          Priority: 1
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 1000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitRule

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        WebACLId: !GetAtt CloudFrontWebACL.Arn
        Origins:
          - Id: S3Origin
            DomainName: !Sub "${FrontendS3Bucket}.s3-${env:REGION}.amazonaws.com"
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${FrontendS3OAI}"
          - Id: ApiGatewayOrigin
            DomainName: !Sub "${HttpApi}.execute-api.${env:REGION}.amazonaws.com"
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          ViewerProtocolPolicy: https-only
        CacheBehaviors:
          - TargetOriginId: ApiGatewayOrigin
            PathPattern: /api/*
            ViewerProtocolPolicy: https-only
            OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - PATCH
              - POST
              - DELETE
        Enabled: true
```

### Post-Deployment Validation:
1. Check CloudFront distribution settings in AWS Console
2. Monitor WAF metrics in CloudWatch
3. Test rate limiting by sending >1000 requests from a single IP
4. Review blocked requests in WAF logs

This configuration enables both core security protections and rate limiting through AWS WAF while maintaining your existing CloudFront setup.

## ChatGPT o1



## Analysis 

Note: The five LLMs have been anonymized in the analysis below, as follows: ChatGPT-4o is Chatbot #1, Gemini 2.0 Flash is Chatbot #2, Q is Chatbot #3, DeepSeek R1 is Chatbot #4 and ChatGPT-o1 is Chatbot #5


